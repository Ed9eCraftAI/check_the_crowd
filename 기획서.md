# 토큰 커뮤니티 검증 서비스 기획서 (MVP)

## 1) 프로젝트 배경

최근 Aztec 상장 이슈로 Binance에서 토큰을 구매하는 과정에서, 충분한 검증 없이 진입해 러그풀 피해를 경험했다.  
이 경험을 바탕으로, 특정 토큰에 대한 `valid` 여부를 개인 판단이 아니라 **커뮤니티 의견으로 빠르게 확인**할 수 있는 시스템의 필요성을 느꼈다.

이 프로젝트의 목적은 자동 분석 엔진을 만드는 것이 아니라,  
커뮤니티가 직접 투표한 결과를 모아 참고 지표를 제공하는 데 있다.

---

## 2) MVP 목표

MVP 단계에서는 복잡한 기능보다 다음 3가지를 우선 구현한다.

1. `register`: 투표를 열 수 있는 등록 기능
2. `vote`: 1지갑 1투표 방식의 커뮤니티 투표
3. `check`: `chain + address` 기준으로 현재 투표 결과 조회

---

## 3) MVP 핵심 기능 상세

### 3-1. Register (투표 오픈)
- 사용자가 특정 토큰에 대해 투표를 시작할 수 있어야 한다.
- 식별 기준은 `chain` + `address` 조합이다.

### 3-2. Vote (1지갑 1투표)
- 하나의 지갑은 하나의 토큰에 대해 1개의 투표권만 가진다.
- 투표 선택지는 아래 3가지다.
  - `valid`
  - `risky`
  - `unknown`

### 3-3. Check (결과 조회)
- 사용자는 `chain`, `address` 입력으로 해당 토큰의 투표 현황을 조회할 수 있어야 한다.
- 조회 결과는 최소한 각 선택지의 집계 수를 포함한다.

---

## 4) MVP 원칙

- 초기 단계에서는 디테일한 고도화보다 작동하는 최소 기능 구현에 집중한다.
- 자동 사기 탐지/정교한 평판 시스템 등은 MVP 범위에서 제외한다.
- 먼저 커뮤니티 투표 데이터가 쌓이고 조회되는 흐름을 완성하는 것을 우선 목표로 한다.

---

## 5) DB 최소 스펙 (MVP)

`token_valid.md` 기준에서 MVP 범위(register/vote/check)에 필요한 최소 모델만 사용한다.

### 5-1. Enum
- `Chain`: `eth | bsc`
- `VoteChoice`: `valid | risky | unknown`

### 5-2. Token
- 용도: 투표가 열려 있는 토큰 식별 (`chain + address`)
- 주요 컬럼
  - `id` (PK)
  - `chain` (enum)
  - `address` (string, lowercase 저장)
  - `createdAt`
- 제약
  - `UNIQUE(chain, address)`

### 5-3. Vote
- 용도: 지갑별 투표 저장
- 주요 컬럼
  - `id` (PK)
  - `tokenId` (FK -> Token.id)
  - `voterWallet` (string, lowercase 저장)
  - `choice` (enum)
  - `signature` (string)
  - `message` (string)
  - `createdAt`
  - `updatedAt`
- 제약
  - `UNIQUE(tokenId, voterWallet)`  
    (같은 지갑이 재투표하면 `upsert`로 덮어쓰기)

### 5-4. Nonce
- 용도: 서명 재사용 방지
- 주요 컬럼
  - `id` (PK)
  - `wallet` (string, lowercase 저장)
  - `nonce` (string)
  - `issuedAt` (datetime)
  - `expiresAt` (datetime, 권장 10분)
  - `usedAt` (datetime nullable)
  - `createdAt`
- 제약
  - `UNIQUE(wallet, nonce)`
  - 사용 후 재사용 불가 (`usedAt` 세팅)

### 5-5. 정규화 규칙
- `address`: 저장 전 lowercase
- `wallet`/`voterWallet`: 저장 전 lowercase
- 주소 포맷: EVM 주소(`0x...`) 유효성 검증 필수

---

## 6) API 최소 스펙 (MVP)

### 6-1. Register
`POST /api/tokens/register`

- 목적: 특정 `chain + address` 투표 오픈
- Request
```json
{
  "chain": "eth",
  "address": "0x..."
}
```
- 동작
  - 주소/체인 유효성 검증
  - `Token` upsert (이미 있으면 그대로 반환)
- Response (예시)
```json
{
  "token": {
    "chain": "eth",
    "address": "0x..."
  }
}
```

### 6-2. Nonce 발급
`POST /api/auth/nonce`

- 목적: 서명용 1회성 nonce 발급
- Request
```json
{ "wallet": "0xabc..." }
```
- Response
```json
{
  "nonce": "random-string",
  "issuedAt": "ISO_TIMESTAMP"
}
```

### 6-3. Vote
`POST /api/votes`

- Request
```json
{
  "chain": "eth",
  "address": "0x...",
  "wallet": "0x...",
  "choice": "risky",
  "nonce": "...",
  "issuedAt": "...",
  "signature": "...",
  "message": "..."
}
```
- 서버 검증
  - signature로 signer 복구 후 `wallet` 일치 확인
  - nonce 유효/미사용/만료 확인
  - message 템플릿 일치 확인
  - `Vote` upsert (`tokenId + voterWallet` 기준)

### 6-4. Check
`GET /api/tokens/:chain/:address`

- 목적: 토큰 투표 집계 조회
- Response
```json
{
  "token": {
    "chain": "eth",
    "address": "0x..."
  },
  "consensus": {
    "total": 31,
    "valid": 10,
    "risky": 18,
    "unknown": 3,
    "label": "RISKY"
  }
}
```
- 집계 규칙
  - 최다 득표 라벨 사용
  - 동률이면 `UNKNOWN`
  - 미존재/무투표도 `UNKNOWN` + `total: 0` 응답

---

## 7) 보안/표시 최소 규칙

- nonce 만료 시간 적용 (권장 10분)
- nonce 재사용 금지
- 1지갑 1표 (재투표는 덮어쓰기)
- 서비스 고지 문구 필수:
  - `This reflects community consensus only. Not financial advice.`
- 주소 저장은 lowercase, UI 표시 주소는 사용자 입력 원본 표시



## 금주 목표 ( ~ 26/02/22 23:59(KST) )
	1.	Supabase Postgres 생성
	2.	Next.js 프로젝트 생성
	3.	Prisma 연결
	4.	Token / Vote 테이블 생성
	5.	/api/tokens 조회 API 구현
	6.	로컬에서 DB 저장 + 조회 성공 확인

---

## 금주 실행 체크리스트 (작업 단위)

### Day 1 - 환경 세팅
- [ ] Supabase 프로젝트 생성
  - 결과물: `Project URL`, `DB Password`, `Connection String` 확보
- [ ] Next.js(App Router) 프로젝트 생성
  - 결과물: 로컬 `npm run dev` 정상 실행

### Day 2 - DB 연결
- [ ] Prisma 설치 및 초기화
  - 실행: `npm i prisma @prisma/client`
  - 실행: `npx prisma init`
- [ ] `.env`에 `DATABASE_URL` 설정
  - 결과물: Supabase Postgres와 연결 문자열 반영
- [ ] Prisma 스키마 작성 (`Chain`, `VoteChoice`, `Token`, `Vote`, `Nonce`)
  - 결과물: `prisma/schema.prisma` 작성 완료

### Day 3 - 마이그레이션/테이블 생성
- [ ] 마이그레이션 실행
  - 실행: `npx prisma migrate dev --name init`
- [ ] Prisma Studio 또는 SQL Editor로 테이블 생성 확인
  - 결과물: `Token`, `Vote`, `Nonce` 테이블 확인

### Day 4 - API 구현
- [ ] `POST /api/tokens/register` 구현
  - 완료 조건: `chain + address` upsert 동작
- [ ] `GET /api/tokens/:chain/:address` 구현
  - 완료 조건: 미존재 시에도 `UNKNOWN + total:0` 응답

### Day 5 - 로컬 검증
- [ ] 샘플 데이터 1~2건 삽입 후 조회 테스트
  - 완료 조건: 저장/조회 모두 정상
- [ ] 간단 API 호출 예시를 README에 기록
  - 완료 조건: 팀원이 그대로 따라 재현 가능

### 주간 완료 기준 (DoD)
- [ ] Supabase 연결 상태에서 Prisma 마이그레이션 성공
- [ ] `/api/tokens/register` 동작 확인
- [ ] `/api/tokens/:chain/:address` 집계 응답 확인
- [ ] 로컬에서 DB 저장 + 조회 성공 로그/스크린샷 확보


## UI 상단 문구.
Before you buy, check the crowd.
Community consensus for new EVM tokens.